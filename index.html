<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場情資與競品分析平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. gapi 載入旗標與 onload 事件 -->
    <script>
    window.gapiLoaded = false;
    function onGapiLoaded() {
        window.gapiLoaded = true;
    }
    // 等待 gapi 載入完成
    function waitForGapiLoaded(callback) {
        if (window.gapiLoaded && window.gapi) {
            callback();
        } else {
            setTimeout(() => waitForGapiLoaded(callback), 50);
        }
    }
    </script>
    <script src="https://apis.google.com/js/api.js" onload="onGapiLoaded()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">

<header class="bg-white shadow-md">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold text-gray-800">市場情資與競品分析平台</h1>
        </div>
        <div id="auth-container">
            <button id="authorize_button" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">使用 Google 登入</button>
            <div id="user-profile" class="hidden items-center gap-3">
                <img id="user-avatar" class="w-10 h-10 rounded-full border-2 border-blue-200" src="" alt="User Avatar">
                <span id="user-name" class="font-semibold text-gray-700"></span>
                <button id="signout_button" class="text-sm text-gray-500 hover:text-gray-800 border border-gray-300 rounded-md px-3 py-1 hover:bg-gray-100 transition">登出</button>
            </div>
        </div>
    </div>
</header>

<main class="container mx-auto px-6 py-8">
    <div class="mb-6 p-4 bg-white rounded-lg shadow">
        <h2 class="font-bold mb-2">API 金鑰設定</h2>
        <div class="mb-2">
          <label for="google-api-key" class="block text-sm font-medium text-gray-700 mb-1">Google API Key</label>
          <input type="password" id="google-api-key" class="w-full p-2 border border-gray-300 rounded-md" placeholder="請輸入你的 Google API Key">
        </div>
        <div class="mb-2">
          <label for="google-cx-id" class="block text-sm font-medium text-gray-700 mb-1">Google 搜尋引擎 ID (CX)</label>
          <input type="text" id="google-cx-id" class="w-full p-2 border border-gray-300 rounded-md" placeholder="請輸入你的 Google Custom Search ID (CX)">
        </div>
        <div class="mb-2">
          <label for="ai-api-key" class="block text-sm font-medium text-gray-700 mb-1">AI API Key (Gemini/Monica)</label>
          <input type="password" id="ai-api-key" class="w-full p-2 border border-gray-300 rounded-md" placeholder="請輸入你的 AI API Key">
        </div>
        <button id="save-settings" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">儲存設定</button>
        <button id="clear-settings" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition ml-2">清除 API Key</button>
    </div>
    <div class="mb-6 p-4 bg-white rounded-lg shadow">
        <h2 class="font-bold mb-2">自訂存檔設定</h2>
        <div class="mb-2">
            <label for="custom-folder-name" class="block text-sm font-medium text-gray-700 mb-1">Google Drive 資料夾名稱</label>
            <input type="text" id="custom-folder-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="預設：MarketIntel_Reports">
        </div>
        <div class="mb-2">
            <label for="custom-file-name" class="block text-sm font-medium text-gray-700 mb-1">自訂檔案名稱（可用變數：<code>{prompt}</code>, <code>{date}</code>）</label>
            <input type="text" id="custom-file-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="範例：{prompt}_{date}">
        </div>
    </div>
    <div id="app-container" class="locked">
        <div class="mb-4">
            <label for="ai-provider" class="block text-sm font-medium text-gray-700 mb-1">AI 提供者</label>
            <select id="ai-provider" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="gemini">Google Gemini</option>
                <option value="monica-gpt-4">Monica GPT-4</option>
                <option value="monica-llama3">Monica Llama-3</option>
            </select>
        </div>
        <div class="mb-4">
            <label for="analysis-prompt" class="block text-sm font-medium text-gray-700 mb-1">分析主題或提示</label>
            <input type="text" id="analysis-prompt" class="w-full p-2 border border-gray-300 rounded-md" placeholder="請輸入你要分析的主題或問題">
        </div>
        <div class="flex gap-2 mb-8">
            <button id="run-analysis" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">執行分析</button>
            <button id="save-analysis" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">儲存至 Google Drive</button>
        </div>
        <div id="analysis-result" class="bg-white p-4 rounded shadow min-h-[100px]"></div>
        <div class="mt-8">
            <h2 class="font-bold text-lg mb-2">Google Drive 歷史分析紀錄</h2>
            <div id="history-list" class="bg-white rounded shadow p-4 max-h-60 overflow-y-auto"></div>
        </div>
    </div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded shadow flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <div id="loading-message" class="text-gray-700">處理中...</div>
        </div>
    </div>
</main>

<script>
const GOOGLE_CLIENT_ID = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
const GEMINI_API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent";
const MONICA_API_ENDPOINT = "https://api.monica.im/v1/chat/completions";

let lastAIResult = null;
let googleUser = null;
let googleAuthInstance = null;
let googleInited = false;
let customFolderName = "";
let customFileNamePattern = "";

function showLoading(msg) {
    document.getElementById('loading-message').textContent = msg || '處理中...';
    document.getElementById('loading-overlay').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
function showAlert(msg) { alert(msg); }

function loadApiKeys() {
    if (localStorage.getItem('googleApiKey')) document.getElementById('google-api-key').value = localStorage.getItem('googleApiKey');
    if (localStorage.getItem('aiApiKey')) document.getElementById('ai-api-key').value = localStorage.getItem('aiApiKey');
    if (localStorage.getItem('googleCxId')) document.getElementById('google-cx-id').value = localStorage.getItem('googleCxId');
    if (localStorage.getItem('customFolderName')) document.getElementById('custom-folder-name').value = localStorage.getItem('customFolderName');
    if (localStorage.getItem('customFileName')) document.getElementById('custom-file-name').value = localStorage.getItem('customFileName');
}
function saveApiKeys() {
    const googleApiKey = document.getElementById('google-api-key').value.trim();
    const aiApiKey = document.getElementById('ai-api-key').value.trim();
    const googleCxId = document.getElementById('google-cx-id').value.trim();
    const folderName = document.getElementById('custom-folder-name').value.trim();
    const fileName = document.getElementById('custom-file-name').value.trim();
    if (!googleApiKey) { alert('請輸入 Google API Key'); return; }
    if (!googleCxId) { alert('請輸入 Google 搜尋引擎 ID (CX)'); return; }
    localStorage.setItem('googleApiKey', googleApiKey);
    localStorage.setItem('aiApiKey', aiApiKey);
    localStorage.setItem('googleCxId', googleCxId);
    localStorage.setItem('customFolderName', folderName);
    localStorage.setItem('customFileName', fileName);
    alert('API Key 與存檔設定已儲存（僅儲存在本機瀏覽器）');
}
function clearApiKeys() {
    localStorage.removeItem('googleApiKey');
    localStorage.removeItem('aiApiKey');
    localStorage.removeItem('googleCxId');
    localStorage.removeItem('customFolderName');
    localStorage.removeItem('customFileName');
    document.getElementById('google-api-key').value = '';
    document.getElementById('ai-api-key').value = '';
    document.getElementById('google-cx-id').value = '';
    document.getElementById('custom-folder-name').value = '';
    document.getElementById('custom-file-name').value = '';
    alert('API Key 與存檔設定已清除');
    document.getElementById('app-container').classList.add('locked');
}

/* Google 登入（只做 Auth2，無需 API key） */
function initGoogleAuth() {
    gapi.load('auth2', () => {
        gapi.auth2.init({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile'
        }).then(() => {
            googleAuthInstance = gapi.auth2.getAuthInstance();
            updateSigninStatus(googleAuthInstance.isSignedIn.get());
            document.getElementById('authorize_button').onclick = () => googleAuthInstance.signIn();
            document.getElementById('signout_button').onclick = () => googleAuthInstance.signOut();
            googleAuthInstance.isSignedIn.listen(updateSigninStatus);
        });
    });
}

function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
        googleUser = googleAuthInstance.currentUser.get();
        const profile = googleUser.getBasicProfile();
        document.getElementById('authorize_button').classList.add('hidden');
        document.getElementById('user-profile').classList.remove('hidden');
        document.getElementById('user-profile').classList.add('flex');
        document.getElementById('user-avatar').src = profile.getImageUrl();
        document.getElementById('user-name').textContent = profile.getName();
        checkAndInitGoogleAPI();
    } else {
        googleUser = null;
        document.getElementById('authorize_button').classList.remove('hidden');
        document.getElementById('user-profile').classList.add('hidden');
        document.getElementById('user-profile').classList.remove('flex');
        document.getElementById('app-container').classList.add('locked');
    }
}

/* 登入+API Key齊全才初始化 gapi.client */
async function checkAndInitGoogleAPI() {
    const googleApiKey = localStorage.getItem('googleApiKey');
    const googleCxId = localStorage.getItem('googleCxId');
    customFolderName = localStorage.getItem('customFolderName') || "MarketIntel_Reports";
    customFileNamePattern = localStorage.getItem('customFileName') || "{prompt}_{date}";
    if (googleUser && googleApiKey && googleCxId) {
        if (!googleInited) {
            try {
                showLoading("初始化 Google API...");
                await gapi.client.init({
                    apiKey: googleApiKey,
                    clientId: GOOGLE_CLIENT_ID,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://www.googleapis.com/discovery/v1/apis/customsearch/v1/rest'
                    ],
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile'
                });
                googleInited = true;
                document.getElementById('app-container').classList.remove('locked');
                loadDriveHistoryList();
                hideLoading();
            } catch (err) {
                hideLoading();
                showAlert("Google API 初始化失敗: " + (err.error || err.message));
                document.getElementById('app-container').classList.add('locked');
            }
        } else {
            document.getElementById('app-container').classList.remove('locked');
            loadDriveHistoryList();
        }
    } else {
        document.getElementById('app-container').classList.add('locked');
    }
}

/* 格式化檔案名稱 */
function formatFileName(prompt) {
    let date = new Date();
    let dateStr = date.getFullYear().toString() +
        ('0'+(date.getMonth()+1)).slice(-2) +
        ('0'+date.getDate()).slice(-2) + "_" +
        ('0'+date.getHours()).slice(-2) +
        ('0'+date.getMinutes()).slice(-2);
    let safePrompt = (prompt || "分析報告").replace(/[\\/:*?"<>|]/g, "_").slice(0, 30);
    let pattern = customFileNamePattern || "{prompt}_{date}";
    return pattern.replace("{prompt}", safePrompt).replace("{date}", dateStr) + ".json";
}

/* Google Drive 資料夾管理 */
async function getOrCreateFolderId() {
    const folderName = customFolderName || "MarketIntel_Reports";
    let res = await gapi.client.drive.files.list({
        q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`,
        fields: "files(id)"
    });
    if (res.result.files.length > 0) return res.result.files[0].id;
    let createRes = await gapi.client.drive.files.create({
        resource: { name: folderName, mimeType: "application/vnd.google-apps.folder" },
        fields: "id"
    });
    return createRes.result.id;
}

/* 儲存分析結果（自訂檔名） */
async function saveReportToDrive(reportObj, prompt) {
    const folderId = await getOrCreateFolderId();
    const boundary = "foo_bar_baz";
    const fileName = formatFileName(prompt);
    const metadata = {
        name: fileName,
        mimeType: "application/json",
        parents: [folderId]
    };
    const multipartRequestBody =
        `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n` +
        `--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(reportObj)}\r\n--${boundary}--`;

    await gapi.client.request({
        path: '/upload/drive/v3/files',
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` },
        body: multipartRequestBody
    });
    showAlert('報告已儲存到 Google Drive！');
    loadDriveHistoryList();
}

/* 歷史紀錄列表 */
async function loadDriveHistoryList() {
    if (!googleInited) return;
    const folderId = await getOrCreateFolderId();
    const res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false and mimeType='application/json'`,
        fields: 'files(id, name, createdTime)',
        orderBy: 'createdTime desc'
    });
    const list = document.getElementById('history-list');
    list.innerHTML = "";
    if (res.result.files.length === 0) {
        list.innerHTML = '<div class="text-gray-500 text-center py-4">尚無歷史紀錄</div>';
    } else {
        res.result.files.forEach(file => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 border-b';
            item.innerHTML = `<span>${file.name.replace('.json', '')}</span>
                <button class="load-history bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs" data-id="${file.id}">載入</button>`;
            item.querySelector('.load-history').onclick = async function() {
                showLoading('載入紀錄中...');
                const fileId = this.dataset.id;
                const resp = await gapi.client.drive.files.get({fileId, alt:'media'});
                hideLoading();
                document.getElementById('analysis-result').textContent = resp.result.result || JSON.stringify(resp.result).slice(0,500);
                lastAIResult = resp.result;
            };
            list.appendChild(item);
        });
    }
}

/* AI 呼叫（Gemini/Monica選擇） */
async function callAI(prompt, provider, model, apiKey) {
    if (provider === "gemini") {
        const url = `${GEMINI_API_ENDPOINT}?key=${apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({contents:[{parts:[{text: prompt}]}]})
        });
        if (!response.ok) throw new Error("Gemini API Error: " + (await response.text()));
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "（無回應）";
    } else if (provider === "monica") {
        const response = await fetch(MONICA_API_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model || "gpt-4-1106-preview",
                messages: [{role: "user", content: prompt}]
            })
        });
        if (!response.ok) throw new Error("Monica API Error: " + (await response.text()));
        const data = await response.json();
        return data.choices?.[0]?.message?.content || "（無回應）";
    }
    throw new Error("目前尚不支援此 AI 來源");
}

/* 主事件流程 */
document.addEventListener('DOMContentLoaded', function() {
    loadApiKeys();
    customFolderName = localStorage.getItem('customFolderName') || "MarketIntel_Reports";
    customFileNamePattern = localStorage.getItem('customFileName') || "{prompt}_{date}";

    document.getElementById('save-settings').onclick = async function() {
        saveApiKeys();
        customFolderName = document.getElementById('custom-folder-name').value.trim() || "MarketIntel_Reports";
        customFileNamePattern = document.getElementById('custom-file-name').value.trim() || "{prompt}_{date}";
        googleInited = false; // 強制重新初始化 gapi.client
        waitForGapiLoaded(checkAndInitGoogleAPI);
    };
    document.getElementById('clear-settings').onclick = function() {
        clearApiKeys();
        googleInited = false;
    };

    // Google 登入初始化（只做 Auth）
    waitForGapiLoaded(initGoogleAuth);

    document.getElementById('run-analysis').onclick = async function() {
        const prompt = document.getElementById('analysis-prompt').value;
        const aiKey = document.getElementById('ai-api-key').value;
        let providerRaw = document.getElementById('ai-provider').value;
        let provider = providerRaw, model = "";
        if (providerRaw.startsWith('monica-')) {
            provider = "monica";
            model = providerRaw.replace("monica-","");
        }
        if (!prompt || !aiKey) { showAlert("請輸入主題與 AI API KEY"); return; }
        showLoading("AI 分析進行中...");
        try {
            const result = await callAI(prompt, provider, model, aiKey);
            document.getElementById('analysis-result').textContent = result;
            lastAIResult = {
                prompt,
                result,
                provider,
                model,
                time: new Date().toISOString()
            };
        } catch(e) {
            document.getElementById('analysis-result').textContent = "AI 呼叫失敗: " + e.message;
            lastAIResult = null;
        }
        hideLoading();
    };

    document.getElementById('save-analysis').onclick = async function() {
        const prompt = document.getElementById('analysis-prompt').value;
        if (!lastAIResult) { showAlert("請先執行分析！"); return; }
        showLoading("儲存至 Google Drive...");
        try {
            waitForGapiLoaded(async () => {
                await saveReportToDrive(lastAIResult, prompt);
            });
        } catch(e) {
            showAlert("儲存失敗: " + e.message);
        }
        hideLoading();
    };
});
</script>
<!-- Monica API 文件：https://docs.monica.im/zh/api.html -->
</body>
</html>
